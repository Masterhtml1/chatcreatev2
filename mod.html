<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moderator Dashboard - ChatCreate</title>
    <link rel="icon" type="image/png" href="https://yourimageshare.com/ib/53MgLPleiK.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f5f5f5;
            min-height: 100vh;
            color: #333;
        }

        /* Header */
        .header {
            padding: 20px;
            background: #2196F3;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logout-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
            text-decoration: none;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Login Container */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .login-title {
            font-size: 28px;
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 16px;
            font-weight: 500;
            color: #555;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: monospace;
        }

        .form-input:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            background: #1976D2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }

        .error-message {
            color: #dc3545;
            font-size: 14px;
            text-align: center;
            margin-top: 15px;
            display: none;
        }

        /* Dashboard Container */
        .dashboard-container {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        .welcome-message {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            text-align: center;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
        }

        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .card-title {
            font-size: 22px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            font-size: 24px;
        }

        /* Live Messages Monitor */
        .live-messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }

        .live-message {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #2196F3;
            position: relative;
        }

        .message-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .message-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .message-author {
            font-weight: bold;
            color: #333;
        }

        .message-channel {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .message-time {
            font-size: 12px;
            color: #666;
        }

        .message-text {
            color: #555;
            margin-bottom: 8px;
        }

        .message-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .warn-btn {
            background: #ff9800;
            color: white;
        }

        .mute-btn {
            background: #9c27b0;
            color: white;
        }

        .ban-btn {
            background: #f44336;
            color: white;
        }

        .profile-btn {
            background: #2196f3;
            color: white;
        }

        .action-btn:hover {
            transform: scale(1.05);
        }

        /* User Profile Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .profile-section {
            margin-bottom: 25px;
        }

        .profile-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .violation-item {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .violation-date {
            font-size: 12px;
            color: #666;
            font-weight: bold;
        }

        .violation-reason {
            margin-top: 5px;
            color: #333;
        }

        /* Direct Message System */
        .dm-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .dm-input, .dm-textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .dm-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .dm-btn {
            padding: 12px 20px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .dm-btn:hover {
            background: #45a049;
        }

        /* Ban/Unban buttons */
        .ban-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .ban-input, .ban-input select, .ban-input textarea {
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .ban-btn {
            padding: 10px 20px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ban-btn:hover {
            background: #da190b;
        }

        .unban-btn {
            background: #4CAF50;
            color: white;
        }

        .unban-btn:hover {
            background: #45a049;
        }

        /* User lists */
        .user-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .user-info {
            flex: 1;
        }

        .user-nickname {
            font-weight: 600;
            color: #333;
        }

        .user-email {
            font-size: 14px;
            color: #666;
        }

        /* Stats */
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .stat-label {
            font-weight: 500;
            color: #555;
        }

        .stat-value {
            font-weight: 700;
            color: #2196F3;
            font-size: 18px;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .message-actions {
                flex-wrap: wrap;
            }

            .action-btn {
                flex: 1;
                min-width: 60px;
                margin-bottom: 3px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <header class="header">
            <div class="logo">
                üëÆ Moderator Dashboard
            </div>
            <a href="index.html" class="logout-btn">Back to Chat</a>
        </header>

        <div class="login-container">
            <h1 class="login-title">Moderator Login</h1>
            <form id="modLoginForm">
                <div class="form-group">
                    <label class="form-label" for="modPassword">Access Code</label>
                    <input type="password" id="modPassword" class="form-input" placeholder="Enter your moderator code" required autofocus>
                </div>
                <button type="submit" class="login-btn">Login</button>
                <div class="error-message" id="errorMessage"></div>
            </form>
            <p style="text-align: center; margin-top: 20px; color: #666; font-size: 14px;">
                Access codes are provided by administrators
            </p>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardScreen" class="dashboard-container">
        <header class="header">
            <div class="logo">
                üëÆ Moderator Dashboard
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </header>

        <div class="welcome-message">
            <h2>Welcome, Moderator!</h2>
            <p>You now have enhanced moderation powers including live monitoring, user profiles, and direct messaging.</p>
            <p><small>Your access code can be used multiple times - no need to request new ones!</small></p>
        </div>

        <div class="dashboard-grid">
            <!-- Live Messages Monitor -->
            <div class="dashboard-card" style="grid-column: span 2;">
                <h2 class="card-title">
                    <span class="card-icon">üëÅÔ∏è</span>
                    Live Messages Monitor
                </h2>
                <div class="live-messages" id="liveMessages">
                    <div style="text-align: center; color: #666; padding: 20px;">
                        Monitoring all channels for new messages...
                    </div>
                </div>
            </div>

            <!-- Direct Messaging -->
            <div class="dashboard-card">
                <h2 class="card-title">
                    <span class="card-icon">üí¨</span>
                    Direct Message User
                </h2>
                <div class="dm-form">
                    <input type="text" id="dmRecipient" class="dm-input" placeholder="Enter username">
                    <select id="dmPriority" class="dm-input">
                        <option value="normal">Normal Message</option>
                        <option value="important">Important</option>
                        <option value="urgent">Urgent</option>
                    </select>
                    <textarea id="dmMessage" class="dm-textarea" placeholder="Type your message..."></textarea>
                    <button class="dm-btn" onclick="sendDirectMessage()">Send Message</button>
                </div>
            </div>

            <!-- User Management with Enhanced Features -->
            <div class="dashboard-card">
                <h2 class="card-title">
                    <span class="card-icon">üö´</span>
                    User Management
                </h2>
                <div class="ban-form">
                    <input type="text" id="banNickname" class="ban-input" placeholder="Nickname to ban">
                    <select id="banDuration" class="ban-input">
                        <option value="permanent">Permanent Ban</option>
                        <option value="24">24 Hours</option>
                        <option value="12">12 Hours</option>
                        <option value="6">6 Hours</option>
                        <option value="1">1 Hour</option>
                    </select>
                    <input type="text" id="banReason" class="ban-input" placeholder="Reason for ban">
                    <button class="ban-btn" onclick="banUser()">Ban User</button>
                </div>
                <div class="user-list" id="bannedUsersList">
                    <div class="loading">Loading banned users...</div>
                </div>
            </div>

            <!-- Channel Monitoring -->
            <div class="dashboard-card">
                <h2 class="card-title">
                    <span class="card-icon">üí¨</span>
                    Active Channels
                </h2>
                <div class="user-list" id="channelsList">
                    <div class="loading">Loading channels...</div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="dashboard-card">
                <h2 class="card-title">
                    <span class="card-icon">üìä</span>
                    Statistics
                </h2>
                <div id="statsContainer">
                    <div class="stat-item">
                        <span class="stat-label">Total Messages Today</span>
                        <span class="stat-value" id="todayMessages">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Active Users</span>
                        <span class="stat-value" id="activeUsers">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Banned Users</span>
                        <span class="stat-value" id="bannedCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Your Actions Today</span>
                        <span class="stat-value" id="modActions">0</span>
                    </div>
                </div>
            </div>

            <!-- User Reports to Admin -->
            <div class="dashboard-card">
                <h2 class="card-title">
                    <span class="card-icon">üì¢</span>
                    Report to Admin
                </h2>
                <div class="ban-form">
                    <input type="text" id="reportUser" class="ban-input" placeholder="Username to report">
                    <select id="reportType" class="ban-input">
                        <option value="">Select report type</option>
                        <option value="harassment">Harassment/Bullying</option>
                        <option value="inappropriate">Inappropriate Content</option>
                        <option value="spam">Spam/Flooding</option>
                        <option value="threatening">Threatening Language</option>
                        <option value="discrimination">Discrimination</option>
                        <option value="other">Other</option>
                    </select>
                    <textarea id="reportDescription" class="ban-input" placeholder="Describe the issue in detail..." rows="3"></textarea>
                    <button class="ban-btn" style="background: #ff9800;" onclick="reportToAdmin()">Send Report</button>
                </div>
            </div>
        </div>

        <!-- User Profile Modal -->
        <div id="userProfileModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="profileUsername">User Profile</h2>
                    <span class="close" onclick="closeProfile()">&times;</span>
                </div>
                
                <div class="profile-section">
                    <h3>User Information</h3>
                    <div id="profileInfo">
                        <!-- User info will be loaded here -->
                    </div>
                </div>
                
                <div class="profile-section">
                    <h3>Recent Messages</h3>
                    <div id="profileMessages">
                        <!-- Recent messages will be loaded here -->
                    </div>
                </div>
                
                <div class="profile-section">
                    <h3>Violations & Warnings</h3>
                    <div id="profileViolations">
                        <!-- Violations will be loaded here -->
                    </div>
                </div>
                
                <div class="profile-section">
                    <h3>Moderator Actions</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="action-btn warn-btn" onclick="warnUser(currentProfileUser)">‚ö†Ô∏è Warn</button>
                        <button class="action-btn mute-btn" onclick="muteUser(currentProfileUser)">üîá Mute</button>
                        <button class="action-btn ban-btn" onclick="quickBanUser(currentProfileUser.nickname, currentProfileUser.email)">üö´ Ban</button>
                        <button class="dm-btn" onclick="openDMToUser(currentProfileUser)">üí¨ Send DM</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD6zrgjxQUboB14H5ysJsTnzsiTBfak1Rk",
            authDomain: "chatcreate-5dfd6.firebaseapp.com",
            databaseURL: "https://chatcreate-5dfd6-default-rtdb.firebaseio.com",
            projectId: "chatcreate-5dfd6",
            storageBucket: "chatcreate-5dfd6.firebasestorage.app",
            messagingSenderId: "992462114118",
            appId: "1:992462114118:web:dbb2711332b900baf36947",
            measurementId: "G-W7SV1FY6NE"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let currentModeratorId = null;
        let currentProfileUser = null;
        let dailyActions = 0;

        // Mod login - REUSABLE CODES VERSION
        document.getElementById('modLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const password = document.getElementById('modPassword').value.trim();
            const errorMsg = document.getElementById('errorMessage');

            if (!password) {
                errorMsg.textContent = 'Please enter an access code';
                errorMsg.style.display = 'block';
                return;
            }

            // Show loading state
            errorMsg.textContent = 'Checking access code...';
            errorMsg.style.color = '#2196F3';
            errorMsg.style.display = 'block';

            // Check password against Firebase
            database.ref('modPasswords').orderByChild('password').equalTo(password).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    let validPassword = false;
                    let passwordKey = null;
                    let passwordData = null;
                    
                    snapshot.forEach((passSnapshot) => {
                        const passData = passSnapshot.val();
                        if (passData.active) {
                            validPassword = true;
                            passwordKey = passSnapshot.key;
                            passwordData = passData;
                        }
                    });
                    
                    if (validPassword) {
                        // Update usage statistics
                        const currentUsage = passwordData.usageCount || 0;
                        database.ref('modPasswords/' + passwordKey).update({
                            usageCount: currentUsage + 1,
                            lastUsedAt: Date.now()
                        }).then(() => {
                            // Login successful
                            document.getElementById('loginScreen').style.display = 'none';
                            document.getElementById('dashboardScreen').style.display = 'block';
                            loadModDashboard();
                        });
                    } else {
                        errorMsg.textContent = 'This access code has been disabled by an administrator.';
                        errorMsg.style.color = '#dc3545';
                        errorMsg.style.display = 'block';
                    }
                } else {
                    errorMsg.textContent = 'Invalid access code.';
                    errorMsg.style.color = '#dc3545';
                    errorMsg.style.display = 'block';
                }
            });
        });

        // Load moderator dashboard
        function loadModDashboard() {
            currentModeratorId = 'Mod-' + Math.random().toString(36).substr(2, 9);
            startLiveMessageMonitoring();
            loadBannedUsers();
            loadChannels();
            loadStats();
            trackDailyActions();
        }

        // Live Message Monitoring (Same as Admin)
        function startLiveMessageMonitoring() {
            const liveContainer = document.getElementById('liveMessages');
            
            database.ref('channels').on('child_added', (channelSnapshot) => {
                const channelName = channelSnapshot.key;
                
                database.ref(`channels/${channelName}/messages`).on('child_added', (messageSnapshot) => {
                    const message = messageSnapshot.val();
                    if (message.author !== 'System') {
                        displayLiveMessage(message, channelName, messageSnapshot.key);
                    }
                });
            });
        }

        function displayLiveMessage(message, channel, messageId) {
            const liveContainer = document.getElementById('liveMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'live-message';
            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="message-info">
                        <span class="message-author">${message.nickname}</span>
                        <span class="message-channel">#${channel}</span>
                        <span class="message-time">${new Date(message.timestamp).toLocaleTimeString()}</span>
                    </div>
                </div>
                <div class="message-text">${message.text}</div>
                <div class="message-actions">
                    <button class="action-btn warn-btn" onclick="warnUser({nickname: '${message.nickname}', email: '${message.author}'})">Warn</button>
                    <button class="action-btn mute-btn" onclick="muteUser({nickname: '${message.nickname}', email: '${message.author}'})">Mute</button>
                    <button class="action-btn ban-btn" onclick="quickBanUser('${message.nickname}', '${message.author}')">Ban</button>
                    <button class="action-btn profile-btn" onclick="viewProfile('${message.nickname}', '${message.author}')">Profile</button>
                </div>
            `;
            
            liveContainer.insertBefore(messageDiv, liveContainer.firstChild);
            
            // Keep only last 50 messages
            while (liveContainer.children.length > 50) {
                liveContainer.removeChild(liveContainer.lastChild);
            }
        }

        // Enhanced User Actions
        function warnUser(user) {
            const reason = prompt(`Enter warning reason for ${user.nickname}:`);
            if (reason) {
                const warning = {
                    type: 'warning',
                    user: user.nickname,
                    reason: reason,
                    timestamp: Date.now(),
                    issuedBy: currentModeratorId
                };
                
                database.ref('userViolations').push(warning);
                sendDirectMessageToUser(user.nickname, `‚ö†Ô∏è Moderator Warning: ${reason}`, 'urgent');
                alert(`Warning sent to ${user.nickname}`);
                incrementDailyActions();
            }
        }

        function muteUser(user) {
            const duration = prompt('Mute duration in minutes:', '60');
            if (duration) {
                const muteData = {
                    user: user.nickname,
                    mutedUntil: Date.now() + (parseInt(duration) * 60000),
                    reason: 'Muted by moderator',
                    timestamp: Date.now(),
                    issuedBy: currentModeratorId
                };
                
                database.ref('mutedUsers').push(muteData);
                sendDirectMessageToUser(user.nickname, `üîá You have been muted for ${duration} minutes by a moderator.`, 'urgent');
                alert(`${user.nickname} muted for ${duration} minutes`);
                incrementDailyActions();
            }
        }

        function quickBanUser(nickname, email) {
            if (confirm(`Ban ${nickname}?`)) {
                const reason = prompt('Ban reason (optional):') || 'Banned by moderator';
                
                database.ref('bannedUsers').push({
                    nickname: nickname,
                    email: email,
                    bannedBy: currentModeratorId,
                    bannedAt: Date.now(),
                    reason: reason,
                    bannedByType: 'Moderator'
                });
                
                alert(`${nickname} has been banned`);
                incrementDailyActions();
            }
        }

        // Enhanced User Profile System
        function viewProfile(nickname, email) {
            currentProfileUser = { nickname, email };
            document.getElementById('profileUsername').textContent = `${nickname} Profile`;
            
            // Load user info
            document.getElementById('profileInfo').innerHTML = `
                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                    <p><strong>Nickname:</strong> ${nickname}</p>
                    <p><strong>Email:</strong> ${email || 'Not available'}</p>
                    <p><strong>First Seen:</strong> ${new Date().toLocaleDateString()}</p>
                    <p><strong>Status:</strong> <span style="color: green;">Active</span></p>
                </div>
            `;
            
            // Load recent messages
            loadUserMessages(nickname);
            
            // Load violations
            loadUserViolations(nickname);
            
            document.getElementById('userProfileModal').style.display = 'block';
        }

        function loadUserMessages(nickname) {
            const container = document.getElementById('profileMessages');
            container.innerHTML = '<div style="color: #666;">Loading recent messages...</div>';
            
            // Get messages from all channels
            database.ref('channels').once('value', (snapshot) => {
                const messages = [];
                snapshot.forEach((channelSnapshot) => {
                    const channelName = channelSnapshot.key;
                    channelSnapshot.child('messages').forEach((messageSnapshot) => {
                        const message = messageSnapshot.val();
                        if (message.nickname === nickname) {
                            message.channel = channelName;
                            message.id = messageSnapshot.key;
                            messages.push(message);
                        }
                    });
                });
                
                messages.sort((a, b) => b.timestamp - a.timestamp);
                const recent = messages.slice(0, 10);
                
                if (recent.length > 0) {
                    container.innerHTML = recent.map(msg => `
                        <div style="background: #f9f9f9; padding: 10px; margin-bottom: 8px; border-radius: 6px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">
                                #${msg.channel} - ${new Date(msg.timestamp).toLocaleString()}
                            </div>
                            <div>${msg.text}</div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div style="color: #666;">No recent messages found.</div>';
                }
            });
        }

        function loadUserViolations(nickname) {
            const container = document.getElementById('profileViolations');
            
            database.ref('userViolations').orderByChild('user').equalTo(nickname).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const violations = [];
                    snapshot.forEach((violationSnapshot) => {
                        violations.push(violationSnapshot.val());
                    });
                    
                    violations.sort((a, b) => b.timestamp - a.timestamp);
                    
                    container.innerHTML = violations.map(violation => `
                        <div class="violation-item">
                            <div class="violation-date">${new Date(violation.timestamp).toLocaleString()}</div>
                            <div class="violation-reason"><strong>${violation.type}:</strong> ${violation.reason}</div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div style="color: #666;">No violations on record.</div>';
                }
            });
        }

        function closeProfile() {
            document.getElementById('userProfileModal').style.display = 'none';
            currentProfileUser = null;
        }

        // Direct Messaging System
        function sendDirectMessage() {
            const recipient = document.getElementById('dmRecipient').value.trim();
            const priority = document.getElementById('dmPriority').value;
            const message = document.getElementById('dmMessage').value.trim();
            
            if (!recipient || !message) {
                alert('Please enter recipient and message');
                return;
            }
            
            sendDirectMessageToUser(recipient, message, priority);
            
            // Clear form
            document.getElementById('dmRecipient').value = '';
            document.getElementById('dmMessage').value = '';
            
            alert(`Direct message sent to ${recipient}`);
            incrementDailyActions();
        }

        function sendDirectMessageToUser(recipient, message, priority = 'normal') {
            const dmData = {
                from: 'Moderator',
                fromId: currentModeratorId,
                to: recipient,
                message: message,
                priority: priority,
                timestamp: Date.now(),
                read: false,
                type: 'direct_message'
            };
            
            database.ref('directMessages').push(dmData);
            
            // Also send as system notification
            const notification = {
                type: 'mod_message',
                recipient: recipient,
                message: message,
                priority: priority,
                timestamp: Date.now(),
                read: false
            };
            
            database.ref('userNotifications').push(notification);
        }

        function openDMToUser(user) {
            document.getElementById('dmRecipient').value = user.nickname;
            closeProfile();
            document.getElementById('dmMessage').focus();
        }

        // Enhanced Ban System
        function banUser() {
            const nickname = document.getElementById('banNickname').value.trim();
            const duration = document.getElementById('banDuration').value;
            const reason = document.getElementById('banReason').value.trim();
            
            if (!nickname) {
                alert('Please enter a nickname to ban');
                return;
            }
            
            if (confirm(`Are you sure you want to ban ${nickname}?${reason ? '\n\nReason: ' + reason : ''}`)) {
                const banData = {
                    nickname: nickname,
                    bannedBy: currentModeratorId,
                    bannedAt: Date.now(),
                    reason: reason || 'No reason provided',
                    bannedByType: 'Moderator',
                    duration: duration
                };
                
                // If temporary ban, set expiration
                if (duration !== 'permanent') {
                    banData.expiresAt = Date.now() + (parseInt(duration) * 60 * 60 * 1000);
                }
                
                database.ref('bannedUsers').push(banData)
                    .then(() => {
                        alert(`${nickname} has been banned ${duration === 'permanent' ? 'permanently' : 'for ' + duration + ' hours'}`);
                        document.getElementById('banNickname').value = '';
                        document.getElementById('banReason').value = '';
                        incrementDailyActions();
                    })
                    .catch((error) => {
                        alert('Error banning user: ' + error.message);
                    });
            }
        }

        // Report to Admin
        function reportToAdmin() {
            const reportedUser = document.getElementById('reportUser').value.trim();
            const reportType = document.getElementById('reportType').value;
            const description = document.getElementById('reportDescription').value.trim();
            
            if (!reportedUser || !reportType || !description) {
                alert('Please fill in all fields');
                return;
            }
            
            const reportData = {
                reportedUser: reportedUser,
                reportType: reportType,
                description: description,
                reportedBy: currentModeratorId,
                timestamp: Date.now(),
                status: 'pending',
                adminResponse: null
            };
            
            database.ref('modReports').push(reportData)
                .then(() => {
                    const notification = {
                        type: 'mod_report',
                        moderatorId: currentModeratorId,
                        reportedUser: reportedUser,
                        reportType: reportType,
                        description: description,
                        timestamp: Date.now(),
                        read: false
                    };
                    
                    return database.ref('adminNotifications').push(notification);
                })
                .then(() => {
                    alert(`Report about ${reportedUser} has been sent to administrators`);
                    document.getElementById('reportUser').value = '';
                    document.getElementById('reportType').value = '';
                    document.getElementById('reportDescription').value = '';
                    incrementDailyActions();
                });
        }

        // Load banned users
        function loadBannedUsers() {
            const bannedList = document.getElementById('bannedUsersList');
            
            database.ref('bannedUsers').on('value', (snapshot) => {
                bannedList.innerHTML = '';
                let count = 0;
                
                if (snapshot.exists()) {
                    snapshot.forEach((bannedSnapshot) => {
                        const banned = bannedSnapshot.val();
                        const key = bannedSnapshot.key;
                        
                        // Check if temporary ban has expired
                        if (banned.expiresAt && banned.expiresAt < Date.now()) {
                            // Auto-unban expired bans
                            database.ref('bannedUsers/' + key).remove();
                            return;
                        }
                        
                        count++;
                        
                        const userItem = document.createElement('div');
                        userItem.className = 'user-item';
                        
                        let durationText = banned.duration === 'permanent' ? 'Permanent' : `${banned.duration}h`;
                        if (banned.expiresAt) {
                            const remaining = Math.ceil((banned.expiresAt - Date.now()) / (60 * 60 * 1000));
                            durationText += ` (${remaining}h left)`;
                        }
                        
                        userItem.innerHTML = `
                            <div class="user-info">
                                <div class="user-nickname">${banned.nickname}</div>
                                <div class="user-email">
                                    ${banned.email || 'No email'} | ${durationText} | 
                                    Banned by: ${banned.bannedByType || 'Admin'} | 
                                    ${banned.reason ? 'Reason: ' + banned.reason : 'No reason provided'}
                                </div>
                            </div>
                            <button class="action-btn unban-btn" onclick="unbanUser('${key}')">Unban</button>
                        `;
                        bannedList.appendChild(userItem);
                    });
                } else {
                    bannedList.innerHTML = '<div class="empty-state">No banned users</div>';
                }
                
                document.getElementById('bannedCount').textContent = count;
            });
        }

        // Unban user
        function unbanUser(key) {
            if (confirm('Unban this user?')) {
                database.ref('bannedUsers/' + key).remove()
                    .then(() => {
                        alert('User unbanned successfully');
                        incrementDailyActions();
                    });
            }
        }

        // Load channels
        function loadChannels() {
            const channelsList = document.getElementById('channelsList');
            
            database.ref('channels').on('value', (snapshot) => {
                channelsList.innerHTML = '';
                
                if (snapshot.exists()) {
                    snapshot.forEach((channelSnapshot) => {
                        const channelName = '#' + channelSnapshot.key;
                        const messageCount = channelSnapshot.child('messages').numChildren();
                        
                        const channelItem = document.createElement('div');
                        channelItem.className = 'user-item';
                        channelItem.innerHTML = `
                            <div class="user-info">
                                <div class="user-nickname">${channelName}</div>
                                <div class="user-email">${messageCount} messages</div>
                            </div>
                        `;
                        channelsList.appendChild(channelItem);
                    });
                } else {
                    channelsList.innerHTML = '<div class="empty-state">No active channels</div>';
                }
            });
        }

        // Load stats
        function loadStats() {
            // Count today's messages
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayTimestamp = today.getTime();
            
            database.ref('channels').once('value', (snapshot) => {
                let todayCount = 0;
                let activeUsersSet = new Set();
                
                snapshot.forEach((channelSnapshot) => {
                    channelSnapshot.child('messages').forEach((messageSnapshot) => {
                        const message = messageSnapshot.val();
                        if (message.timestamp >= todayTimestamp) {
                            todayCount++;
                            if (message.author !== 'System') {
                                activeUsersSet.add(message.nickname);
                            }
                        }
                    });
                });
                
                document.getElementById('todayMessages').textContent = todayCount;
                document.getElementById('activeUsers').textContent = activeUsersSet.size;
            });
        }

        // Track daily actions
        function trackDailyActions() {
            const today = new Date().toDateString();
            const savedDate = localStorage.getItem('modActionDate');
            const savedCount = localStorage.getItem('modActionCount');
            
            if (savedDate === today) {
                dailyActions = parseInt(savedCount) || 0;
            } else {
                dailyActions = 0;
                localStorage.setItem('modActionDate', today);
                localStorage.setItem('modActionCount', '0');
            }
            
            document.getElementById('modActions').textContent = dailyActions;
        }

        function incrementDailyActions() {
            dailyActions++;
            document.getElementById('modActions').textContent = dailyActions;
            localStorage.setItem('modActionCount', dailyActions.toString());
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('dashboardScreen').style.display = 'none';
                document.getElementById('modPassword').value = '';
                document.getElementById('errorMessage').style.display = 'none';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('userProfileModal');
            if (event.target === modal) {
                closeProfile();
            }
        }
    </script>
</body>
</html>
